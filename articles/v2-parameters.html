<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Choosing parameters for supercells • supercells</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Choosing parameters for supercells">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">supercells</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.9.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><h6 class="dropdown-header" data-toc-skip>Version 2.0</h6></li>
    <li><a class="dropdown-item" href="../articles/v2-changes-since-v1.html">Main changes since version 1.0.0</a></li>
    <li><a class="dropdown-item" href="../articles/v2-intro.html">Introduction to supercells</a></li>
    <li><a class="dropdown-item" href="../articles/v2-parameters.html">Choosing parameters for supercells</a></li>
    <li><a class="dropdown-item" href="../articles/v2-evaluation.html">Evaluation and diagnostics</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Version 1.0</h6></li>
    <li><a class="dropdown-item" href="../articles/v1-main-function.html">The supercells() function</a></li>
    <li><a class="dropdown-item" href="../articles/v1-benchmarks.html">Benchmarks</a></li>
    <li><a class="dropdown-item" href="../articles/v1-one_var.html">Superpixels of a single raster layer</a></li>
    <li><a class="dropdown-item" href="../articles/v1-rgb_vars.html">Superpixels of an RGB raster</a></li>
    <li><a class="dropdown-item" href="../articles/v1-motifels.html">Superpixels of spatial categorical patterns</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/Nowosad/supercells/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Choosing parameters for supercells</h1>
                        <h4 data-toc-skip class="author">Jakub
Nowosad</h4>
            
            <h4 data-toc-skip class="date">2026-02-09</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/Nowosad/supercells/blob/main/vignettes/articles/v2-parameters.Rmd" class="external-link"><code>vignettes/articles/v2-parameters.Rmd</code></a></small>
      <div class="d-none name"><code>v2-parameters.Rmd</code></div>
    </div>

    
    
<p>This vignette focuses on how parameters affect the supercell output,
with the main choices being <code>step</code> or <code>k</code>, the
<code>compactness</code> value, and the distance and averaging
functions. The goal is not to find one universal set of parameters, but
to choose values that match your intent.</p>
<p>All examples use the <code>volcano</code> raster for simplicity, but
the same ideas apply to larger and multi-layer rasters.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jakubnowosad.com/supercells/">supercells</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">vol</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"raster/volcano.tif"</span>, package <span class="op">=</span> <span class="st">"supercells"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="supercells-algorithm">Supercells algorithm<a class="anchor" aria-label="anchor" href="#supercells-algorithm"></a>
</h2>
<p>The supercells algorithm is an iterative process that starts with
initial centers and assigns pixels to the nearest center based on a
combined distance that incorporates both value similarity and spatial
proximity. After the initial assignment, the algorithm updates the
centers by averaging the values of the assigned pixels and recalculating
the combined distance for the next iteration. This process continues
until the specified number of iterations is reached.</p>
<p>In this package, the combined distance follows the standard SLIC
form:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi><mo>=</mo><msqrt><mrow><msup><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><msub><mi>d</mi><mi>s</mi></msub><mtext mathvariant="normal">step</mtext></mfrac><mo stretchy="true" form="postfix">)</mo></mrow><mn>2</mn></msup><mo>+</mo><msup><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><msub><mi>d</mi><mi>v</mi></msub><mi>c</mi></mfrac><mo stretchy="true" form="postfix">)</mo></mrow><mn>2</mn></msup></mrow></msqrt></mrow><annotation encoding="application/x-tex">
D = \sqrt{\left(\frac{d_s}{\text{step}}\right)^2 + \left(\frac{d_v}{c}\right)^2}
</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>d</mi><mi>s</mi></msub><annotation encoding="application/x-tex">d_s</annotation></semantics></math>
is the spatial distance in grid-cell units,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>d</mi><mi>v</mi></msub><annotation encoding="application/x-tex">d_v</annotation></semantics></math>
is the value-space distance (from <code>dist_fun</code>), and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>c</mi><annotation encoding="application/x-tex">c</annotation></semantics></math>
is the <code>compactness</code> value. When <code>step</code> is
provided as <code>use_meters(...)</code>, it is converted to cells
before segmentation; distances are still computed in grid-cell units.
Larger <code>compactness</code> down-weights the value term, making
shapes more regular, while smaller values emphasize value
similarity.</p>
</div>
<div class="section level2">
<h2 id="choosing-step-or-k">Choosing step or k<a class="anchor" aria-label="anchor" href="#choosing-step-or-k"></a>
</h2>
<p>You can control the number and size of supercells using either
<code>step</code> or <code>k</code>. <code>step</code> defines the
spacing of initial centers in pixel units (or map units when given as
<code>use_meters(...)</code>). Smaller <code>step</code> values produce
more and smaller supercells, while larger values produce fewer and
larger supercells. For example, <code>step = 8</code> creates centers
approximately every 8 pixels, which leads to supercells that are roughly
8 by 8 pixels in size, depending on the compactness.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sc_step</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sc_slic.html">sc_slic</a></span><span class="op">(</span><span class="va">vol</span>, step <span class="op">=</span> <span class="fl">8</span>, compactness <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<p>By default, <code>step</code> is in pixel units, but instead we can
also specify it in map units with <code><a href="../reference/use_meters.html">use_meters()</a></code>. This allows
us to think about the spatial scales of expected supercells in terms of
the actual map units. For example, if your raster has a resolution of 10
meters, then <code>step = use_meters(200)</code> would create centers
approximately every 200 meters, which corresponds to every 20
pixels.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sc_step_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sc_slic.html">sc_slic</a></span><span class="op">(</span><span class="va">vol</span>, step <span class="op">=</span> <span class="fu"><a href="../reference/use_meters.html">use_meters</a></span><span class="op">(</span><span class="fl">200</span><span class="op">)</span>, compactness <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<p><code>k</code> specifies the desired number of supercells and the
algorithm chooses an approximate step size. This is convenient when you
want a target number instead of a target spatial scale.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sc_k</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sc_slic.html">sc_slic</a></span><span class="op">(</span><span class="va">vol</span>, k <span class="op">=</span> <span class="fl">100</span>, compactness <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<p>In practice, use <code>step</code> when spatial scale matters, and
use <code>k</code> when you want a fixed count across datasets.
Importantly, both approaches still require a sensible
<code>compactness</code> value.</p>
<!--
1.
You can also preview the initial center spacing with `sc_slic_points(iter = 0)`.
This can help confirm whether your `step` or `k` choice aligns with your intended scale.


``` r
centers_preview <- sc_slic_points(vol, step = 8, compactness = 5, iter = 0)
terra::plot(vol)
plot(sf::st_geometry(centers_preview), add = TRUE, pch = 3, col = "red")
```

<img src="v2-parameters_files/figure-html/unnamed-chunk-6-1.png" class="r-plt" alt="" width="700" />

2. also custom centers
-->
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sc_step_small</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sc_slic.html">sc_slic</a></span><span class="op">(</span><span class="va">vol</span>, step <span class="op">=</span> <span class="fl">6</span>, compactness <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">sc_step_large</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sc_slic.html">sc_slic</a></span><span class="op">(</span><span class="va">vol</span>, step <span class="op">=</span> <span class="fl">12</span>, compactness <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">vol</span>, main <span class="op">=</span> <span class="st">"step = 6"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sc_step_small</span><span class="op">[</span><span class="fl">0</span><span class="op">]</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, border <span class="op">=</span> <span class="st">"red"</span>, lwd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">vol</span>, main <span class="op">=</span> <span class="st">"step = 12"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sc_step_large</span><span class="op">[</span><span class="fl">0</span><span class="op">]</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, border <span class="op">=</span> <span class="st">"red"</span>, lwd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></code></pre></div>
<p><img src="v2-parameters_files/figure-html/unnamed-chunk-7-1.png" class="r-plt" alt="" width="700"><img src="v2-parameters_files/figure-html/unnamed-chunk-7-2.png" class="r-plt" alt="" width="700"></p>
</div>
<div class="section level2">
<h2 id="choosing-compactness">Choosing compactness<a class="anchor" aria-label="anchor" href="#choosing-compactness"></a>
</h2>
<p><code>compactness</code> controls the tradeoff between spatial
regularity and value similarity: lower values favor value similarity and
may create irregular shapes, while higher values favor more regular
shapes but can mix dissimilar values.</p>
<p>In general, it is hard to predict the best <code>compactness</code>
value without testing, and it depends on many factors including the
range and distribution of values in your raster, the selected distance
function, and the spatial structure of the data.</p>
<p>You can see this tradeoff by comparing two compactness values with
the same step.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sc_compact_low</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sc_slic.html">sc_slic</a></span><span class="op">(</span><span class="va">vol</span>, step <span class="op">=</span> <span class="fl">8</span>, compactness <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">sc_compact_high</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sc_slic.html">sc_slic</a></span><span class="op">(</span><span class="va">vol</span>, step <span class="op">=</span> <span class="fl">8</span>, compactness <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">vol</span>, main <span class="op">=</span> <span class="st">"compactness = 1"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sc_compact_low</span><span class="op">[</span><span class="fl">0</span><span class="op">]</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, border <span class="op">=</span> <span class="st">"red"</span>, lwd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">vol</span>, main <span class="op">=</span> <span class="st">"compactness = 10"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sc_compact_high</span><span class="op">[</span><span class="fl">0</span><span class="op">]</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, border <span class="op">=</span> <span class="st">"red"</span>, lwd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></code></pre></div>
<p><img src="v2-parameters_files/figure-html/unnamed-chunk-8-1.png" class="r-plt" alt="" width="700"><img src="v2-parameters_files/figure-html/unnamed-chunk-8-2.png" class="r-plt" alt="" width="700"></p>
<div class="section level3">
<h3 id="tuning-compactness">Tuning compactness<a class="anchor" aria-label="anchor" href="#tuning-compactness"></a>
</h3>
<p>The <code><a href="../reference/sc_tune_compactness.html">sc_tune_compactness()</a></code> function estimates a
reasonable starting value from a short run of the algorithm.</p>
<p>It supports two summaries with <code>metric = "global"</code> and
<code>metric = "local"</code>. The global version looks at overall
balance between value and spatial distances, while the local version
uses a neighborhood-based value scale. More precisely:</p>
<ul>
<li>
<strong>Global</strong>: runs a short pilot segmentation
(<code>iter = 1</code> by default), computes pixel-level
<code>spatial</code> and <code>value</code> distances, then takes their
medians over pixels. The compactness is estimated as
<code>compactness = (median(value) / value_scale) * step / median(spatial)</code>.<br>
This aligns the median value and spatial terms in the combined
distance.</li>
<li>
<strong>Local</strong>: computes, for each center, the mean value
distance within a local
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mo>×</mo><mtext mathvariant="normal">step</mtext></mrow><annotation encoding="application/x-tex">2 \times \text{step}</annotation></semantics></math>
window, then returns the median of those per-center means (after
<code>value_scale</code>).<br>
This yields a compactness tied to local value variability, without
explicitly using spatial distances.</li>
</ul>
<p>The local estimate is often more stable for heterogeneous
rasters.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tune_global</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sc_tune_compactness.html">sc_tune_compactness</a></span><span class="op">(</span><span class="va">vol</span>, step <span class="op">=</span> <span class="fl">8</span>, metric <span class="op">=</span> <span class="st">"global"</span><span class="op">)</span></span>
<span><span class="va">tune_local</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sc_tune_compactness.html">sc_tune_compactness</a></span><span class="op">(</span><span class="va">vol</span>, step <span class="op">=</span> <span class="fl">8</span>, metric <span class="op">=</span> <span class="st">"local"</span><span class="op">)</span></span>
<span><span class="va">tune_global</span></span>
<span><span class="co">#&gt;   step metric  dist_fun compactness</span></span>
<span><span class="co">#&gt; 1    8 global euclidean    6.864497</span></span>
<span><span class="va">tune_local</span></span>
<span><span class="co">#&gt;   step metric  dist_fun compactness</span></span>
<span><span class="co">#&gt; 1    8  local euclidean    9.084872</span></span></code></pre></div>
<p>Both results return a one-row data frame with <code>step</code>,
<code>metric</code>, <code>dist_fun</code>, and
<code>compactness</code>. You can plug the suggested value into
<code><a href="../reference/sc_slic.html">sc_slic()</a></code> by setting <code>compactness</code> to the
estimated value.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sc_tuned</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sc_slic.html">sc_slic</a></span><span class="op">(</span><span class="va">vol</span>, step <span class="op">=</span> <span class="fl">8</span>, compactness <span class="op">=</span> <span class="va">tune_global</span><span class="op">$</span><span class="va">compactness</span><span class="op">)</span></span></code></pre></div>
<p>If your raster has many layers, the value distances can be large. The
<code>value_scale</code> argument controls the scaling of value
distances before the compactness estimate. Global:
<code>compactness = (median(value) / value_scale) * step / median(spatial)</code>.
Local:
<code>compactness = median(local_mean_value / value_scale)</code>. Use
<code>"auto"</code> (<code>sqrt(nlyr(x))</code>) for Euclidean-like
distances; for bounded/angular distances (e.g., cosine),
<code>value_scale = 1</code> is often better.</p>
</div>
<div class="section level3">
<h3 id="automatic-compactness">Automatic compactness<a class="anchor" aria-label="anchor" href="#automatic-compactness"></a>
</h3>
<p>For heterogeneous rasters, <code>compactness = use_adaptive()</code>
enables SLIC0-style adaptive compactness. This adjusts the value scale
per supercell and often improves local adaptation. At the same time, it
reduces direct control, so use it when a single global compactness is
hard to choose. Importantly, it still uses your chosen
<code>dist_fun</code> for value distances.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sc_auto</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sc_slic.html">sc_slic</a></span><span class="op">(</span><span class="va">vol</span>, step <span class="op">=</span> <span class="fl">8</span>, compactness <span class="op">=</span> <span class="fu"><a href="../reference/use_adaptive.html">use_adaptive</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">vol</span>, main <span class="op">=</span> <span class="st">"compactness = adaptive"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sc_auto</span><span class="op">[</span><span class="fl">0</span><span class="op">]</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, border <span class="op">=</span> <span class="st">"red"</span>, lwd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></code></pre></div>
<p><img src="v2-parameters_files/figure-html/unnamed-chunk-12-1.png" class="r-plt" alt="" width="700"></p>
<p>When you compare results, keep in mind that metrics from adaptive
compactness are not directly comparable to fixed-compactness runs. You
can still compare spatial metrics, but value metrics reflect local
scaling when <code>compactness = use_adaptive()</code>.</p>
</div>
<div class="section level3">
<h3 id="manual-tuning">Manual tuning<a class="anchor" aria-label="anchor" href="#manual-tuning"></a>
</h3>
<p>A parallel approach to deciding on <code>compactness</code> is to run
a small grid of values and compare the global metrics. It allows you to
see the tradeoffs between spatial and value distances across a range of
compactness settings.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cmp_vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">5</span>, <span class="fl">8</span><span class="op">)</span></span>
<span><span class="va">cmp_metrics</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">cmp_vals</span>, <span class="kw">function</span><span class="op">(</span><span class="va">cmp</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">sc_i</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sc_slic.html">sc_slic</a></span><span class="op">(</span><span class="va">vol</span>, step <span class="op">=</span> <span class="fl">8</span>, compactness <span class="op">=</span> <span class="va">cmp</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/sc_metrics_global.html">sc_metrics_global</a></span><span class="op">(</span><span class="va">vol</span>, <span class="va">sc_i</span>, scale <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="va">cmp_metrics</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">cmp_metrics</span><span class="op">)</span></span>
<span><span class="va">cmp_metrics</span></span>
<span><span class="co">#&gt;   step compactness adaptive_method n_supercells mean_spatial_dist_scaled</span></span>
<span><span class="co">#&gt; 1    8           1            &lt;NA&gt;           90                0.5500066</span></span>
<span><span class="co">#&gt; 2    8           3            &lt;NA&gt;           88                0.5246759</span></span>
<span><span class="co">#&gt; 3    8           5            &lt;NA&gt;           89                0.4982282</span></span>
<span><span class="co">#&gt; 4    8           8            &lt;NA&gt;           88                0.4610799</span></span>
<span><span class="co">#&gt;   mean_value_dist_scaled mean_combined_dist    balance</span></span>
<span><span class="co">#&gt; 1              2.1412253          2.3003626  1.1923986</span></span>
<span><span class="co">#&gt; 2              0.7473867          0.9994451  0.2193843</span></span>
<span><span class="co">#&gt; 3              0.4746065          0.7533578 -0.1505373</span></span>
<span><span class="co">#&gt; 4              0.3358298          0.6175536 -0.4145741</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="distance-and-averaging-functions">Distance and averaging functions<a class="anchor" aria-label="anchor" href="#distance-and-averaging-functions"></a>
</h2>
<p>The <code>dist_fun</code> argument defines how similarity is measured
in value space. Built-in options include <code>"euclidean"</code>,
Jensen–Shannon divergence, and dynamic time warping. You can also pass a
name of the distance measure from the <strong>philentropy</strong>
package<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt; See the &lt;strong&gt;philentropy&lt;/strong&gt; documentation at
&lt;a href="https://drostlab.github.io/philentropy/articles/Distances.html" class="external-link uri"&gt;https://drostlab.github.io/philentropy/articles/Distances.html&lt;/a&gt;.&lt;/p&gt;'><sup>1</sup></a>
or a custom function that takes two numeric vectors and returns a single
number. If you use a custom distance, ensure it returns a single finite
number.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sc_manhattan</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sc_slic.html">sc_slic</a></span><span class="op">(</span><span class="va">vol</span>, step <span class="op">=</span> <span class="fl">8</span>, compactness <span class="op">=</span> <span class="fl">5</span>, dist_fun <span class="op">=</span> <span class="st">"manhattan"</span><span class="op">)</span></span></code></pre></div>
<p>The <code>avg_fun</code> argument controls how values are summarized
within each supercell. The SLIC algorithm iteratively updates supercell
centers based on the average value of the assigned pixels – and with
this argument you can choose how that average is calculated. The default
is <code>"mean"</code>, and <code>"median"</code> is an alternative,
often more robust to outliers.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sc_median</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sc_slic.html">sc_slic</a></span><span class="op">(</span><span class="va">vol</span>, step <span class="op">=</span> <span class="fl">8</span>, compactness <span class="op">=</span> <span class="fl">5</span>, avg_fun <span class="op">=</span> <span class="st">"median"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">vol</span>, main <span class="op">=</span> <span class="st">"dist_fun = manhattan"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">sc_manhattan</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, border <span class="op">=</span> <span class="st">"red"</span>, lwd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">vol</span>, main <span class="op">=</span> <span class="st">"avg_fun = median"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">sc_median</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, border <span class="op">=</span> <span class="st">"red"</span>, lwd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></code></pre></div>
<p><img src="v2-parameters_files/figure-html/unnamed-chunk-16-1.png" class="r-plt" alt="" width="700"><img src="v2-parameters_files/figure-html/unnamed-chunk-16-2.png" class="r-plt" alt="" width="700"></p>
<p>If you change <code>dist_fun</code> or <code>avg_fun</code>, you
should remember to update <code>compactness</code>. Different distances
change the scale of value differences and therefore the balance with the
spatial term.</p>
<p>After tuning, use <code><a href="../reference/sc_metrics_pixels.html">sc_metrics_pixels()</a></code>,
<code><a href="../reference/sc_metrics_supercells.html">sc_metrics_supercells()</a></code>, or
<code><a href="../reference/sc_metrics_global.html">sc_metrics_global()</a></code> to compare runs. These functions accept
the raster as <code>x</code> and the supercells as <code>sc</code>, and
they reuse the stored <code>dist_fun</code> when available. See the
evaluation vignette for guidance on interpreting these metrics: <a href="https://jakubnowosad.com/supercells/articles/v2-evaluation.html" class="uri">https://jakubnowosad.com/supercells/articles/v2-evaluation.html</a>.</p>
</div>
<div class="section level2">
<h2 id="connectivity-and-minimum-size">Connectivity and minimum size<a class="anchor" aria-label="anchor" href="#connectivity-and-minimum-size"></a>
</h2>
<p>The <code>clean</code> argument, enabled by default, enforces
connectivity and removes small fragments that may arise during the
iterative process of assigning pixels to supercells. This is usually
desirable for polygon outputs and downstream analyses. The
<code>minarea</code> argument sets a minimum expected size in pixels for
supercells, and smaller supercells are merged into neighbors. By
default, when <code>clean = TRUE</code>, a minimum size is still
enforced internally (about one quarter of the average supercell size),
so small fragments are merged unless you turn off cleaning. If you see
many tiny supercells, increase <code>minarea</code> or
<code>step</code>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sc_clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sc_slic.html">sc_slic</a></span><span class="op">(</span><span class="va">vol</span>, step <span class="op">=</span> <span class="fl">8</span>, compactness <span class="op">=</span> <span class="fl">5</span>, clean <span class="op">=</span> <span class="cn">TRUE</span>, minarea <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span></code></pre></div>
<p>If you need unpostprocessed supercells for speed or debugging, you
can set <code>clean = FALSE</code>.</p>
</div>
<div class="section level2">
<h2 id="iterations">Iterations<a class="anchor" aria-label="anchor" href="#iterations"></a>
</h2>
<p>You can inspect how the algorithm converges over iterations with
<code><a href="../reference/sc_slic_convergence.html">sc_slic_convergence()</a></code>. It returns a data frame with
per-iteration mean distance and has a dedicated <code><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot()</a></code>
method.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sc_conv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sc_slic_convergence.html">sc_slic_convergence</a></span><span class="op">(</span><span class="va">vol</span>, step <span class="op">=</span> <span class="fl">8</span>, compactness <span class="op">=</span> <span class="fl">5</span>, iter <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sc_conv</span><span class="op">)</span></span></code></pre></div>
<p><img src="v2-parameters_files/figure-html/unnamed-chunk-18-1.png" class="r-plt" alt="" width="700"></p>
<p>Use the diagnostics to decide whether fewer iterations are
sufficient. If the curves stabilize early, you can reduce
<code>iter</code> to speed up large runs.</p>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jakub Nowosad.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
